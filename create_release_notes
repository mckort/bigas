#!/usr/bin/env python3
"""
CLI wrapper for the Product tool `create_release_notes`.

Usage:
  create_release_notes 1.1.0
"""

import json
import os
import sys

from bigas.resources.product.create_release_notes.service import CreateReleaseNotesService, ReleaseNotesError


def _load_dotenv_fallback() -> None:
    """
    Load environment variables from a local .env file without external deps.
    This is intentionally minimal and only supports KEY=VALUE lines.
    """
    env_path = os.path.join(os.path.dirname(__file__), ".env")
    if not os.path.exists(env_path):
        return

    try:
        with open(env_path, "r", encoding="utf-8") as f:
            for raw in f:
                line = raw.strip()
                if not line or line.startswith("#") or "=" not in line:
                    continue
                key, value = line.split("=", 1)
                key = key.strip()
                value = value.strip().strip('"').strip("'")
                if key and key not in os.environ:
                    os.environ[key] = value
    except Exception:
        # If .env parsing fails, keep going; user may have env vars set already.
        return


def main(argv: list[str]) -> int:
    try:
        from dotenv import load_dotenv  # type: ignore
        load_dotenv()
    except Exception:
        _load_dotenv_fallback()

    if len(argv) != 2 or argv[1] in ("-h", "--help"):
        print("Usage: create_release_notes <fix_version>", file=sys.stderr)
        return 2

    fix_version = argv[1]

    try:
        service = CreateReleaseNotesService()
        result = service.create(fix_version=fix_version)
        print(json.dumps(result, indent=2, ensure_ascii=False))
        return 0
    except ReleaseNotesError as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1
    except Exception as e:
        print(f"Unexpected error: {e}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))

